#INCLUDE "PROTHEUS.CH" 
#INCLUDE "RWMAKE.CH" 
#INCLUDE 'COLORS.CH' 
#INCLUDE "TOPCONN.CH"  
#INCLUDE "PRCONST.CH"
#INCLUDE "FWMVCDEF.CH"
#Include "TbiConn.ch"
#INCLUDE "APWIZARD.CH"
#INCLUDE "FILEIO.CH"
#INCLUDE "RPTDEF.CH"                                      
#INCLUDE "FWPrintSetup.ch"
#INCLUDE "TOTVS.CH"
#INCLUDE "PARMTYPE.CH"

//#INCLUDE "MATC090.CH"

/*/
�������������������������������������������������������������������������������
�������������������������������������������������������������������������������
���������������������������������������������������������������������������Ŀ��
���Fun��o    �QUAA080W	� Autor � Luiz Enrique	        � Data � 01/01/2019 ���
���������������������������������������������������������������������������Ĵ��
���Descri��o �GESTAO DE CONTRATOS COMERCIAIS                				���
���������������������������������������������������������������������������Ĵ��
��� Uso      �NOVAMIX	                                                    ���
����������������������������������������������������������������������������ٱ�
�������������������������������������������������������������������������������
�������������������������������������������������������������������������������*/
User Function QUAA080W() 

Local aCoors	:= FWGetDialogSize( oMainWnd )
Local cCadastro	:= "GESTAO DE CONTRATOS COMERCIAIS"  
Local oC1W1 		// Layer pricipal   
Local oC1W2 		// Layer secundario
Local oButt1   		// Botoes para o Pedido
//Variaveis para os Browses
Local oPedido		// Lista dos Pedidos
Local cPed			// Codigo do Pedido Atual
Local oBroItp		// Lista dos Itens do Pedido 
Local oDesbloq		// Lista dos Pedidos Desbloquados
Local oPanC1W1		// Paineis na Janela do Pedido 
Local oPanPri
Local oPasta 		//Pastas para "PEDIDOS","DESBLOQUEIOS DO PEDIDO","BLOQUEIOS POR VALOR MINIMO"		
Local libera	:= .F. 
Local lHist		:= .F.
Local lfirst	:= .T.
Local oHist 
Private oCodCli
Private oCodLoja
Private oBand
Private oDBand
Private oCodPro
Private oProd
Private oCliente
Private oNota
Private oSerie
Private oFilial
Private oNomCtr
Private cCodCli  	:= Space(TamSx3("A1_COD")[1])   
Private cLojaCli 	:= Space(TamSx3("A1_LOJA")[1])
Private cBand  		:= Space(TamSx3("A1_COD")[1])   
Private cDBand		:= Space(45)
Private cCodPro  	:= Space(TamSx3("B1_COD")[1])   
Private cProd		:= Space(45)
Private cCliente	:= Space(45)
Private cNota		:= Space(9)
Private cSerie		:= Space(3)
Private oCBX1 
Private cNctr 		:= Space(200)
Private cXFilial	:= Space(2)

Private oSaldoPed		// Lista dos Pedidos Gerados Por Saldo (corte)
Private oPanBotoes
Private oDlg1
Private aPedidos	:= {}     
Private cMarca 		:= GetMark()
Private aOrd1		:= {}
Private cFilBloq1
Private cOperador 
Private aVerBloq 	:= {}  
Private oSim		:= LoadBitmap(GetResources(),'lbtik') //lbok
Private oNao		:= LoadBitmap(GetResources(),'lbno') 
Private aLsc6		:= {} 
Private aLsc61		:= {} 
Private oItens
Private oItens1
Private oItens2

Private aItens	:= {}
Private aItens1	:= {}
Private aItens2	:= {}

//Legendas
Private  aLegBloq	:= {}
Private aCores 		:= {} 
Private oDataDe 	
Private dDataDe		:= dDataBase-5
Private oPanRoda
Private oValPed
Private nValPed := 0
Private oKgsPed
Private nKgsPed := 0
Private oPedRoda
Private cPedRoda := Space(6)
Private aSaldoPed 	:= {}
Private cFilCmb2 := ""
Private cFilCmb1 := ""
Private cFilCmb3 := ""


Private AFILBRW := {}

//DEFINE AS LEGENDAS DO MODULO
aAdd(aLegBloq, 	{"BR_VERDE"		,"Liberado"})
aAdd(aLegBloq,	{"BR_AZUL"		,"Liberado Pelo Gestor"}) 
aAdd(aLegBloq,	{"BR_VERMELHO"	,"Bloqueado"})
aAdd(aLegBloq,	{"BR_LARANJA"	,"Bloqueado-Pedido de saldo(CORTE)"})

cNomeUsu := Alltrim(UsrRetName(__cUserId))

//��������������������������������������������������������������Ŀ
//� Ativa tecla F4 para comunicacao com Saldos dos Lotes         �
//����������������������������������������������������������������
//Set Key VK_F4 TO ShowF4(aLsc6[oBroItp:nAT,4],"01")
//vscode
cTxtTit:= "GEST�O DE CONTRATOS COMERCIAIS -  Login:  " 

cCadastro:= cTxtTit + cNomeUsu +  "       " + Dtoc(Ddatabase) + " - " + Time()  

DEFINE FONT oFont4	NAME "Arial" 		SIZE 08,10	BOLD 
DEFINE FONT oFont2	NAME "Arial" 		SIZE 11,15 BOLD
DEFINE FONT oFont5	NAME "Arial" 		SIZE 9,15 BOLD  
DEFINE FONT oFont6	NAME "Arial" 		SIZE 7,13 BOLD
 
DEFINE MSDIALOG oDlg1 FROM aCoors[1],aCoors[2] TO aCoors[3],aCoors[4] TITLE cCadastro OF oMainWnd COLOR "W+/W" STYLE nOR(WS_VISIBLE,WS_POPUP) PIXEL 

oDlg1:lEscClose:= .F.
oDlg1:lMaximized := .T.	
oFWLayer:= FWLayer():New()
oFWLayer:init( oDlg1, .F. ) // Segundo parametro: Cria um botao de fechar utilizado para Dlg sem cabe�alho. Caso for .t.	  

//COLUNA - JANELA 1=====================================================================================================================================
oFWLayer:addLine ("Lin01",60,.F.)
oFWLayer:addCollumn( "Col01",100, .F.,"Lin01")
oFWLayer:addWindow( "Col01", "Win01", cCadastro, 50, .T., .F.,,"Lin01")
oC1W1:= oFWLayer:getWinPanel( "Col01", "Win01","Lin01")  

//==TECLAS DE ATALHO ============================================================================================
bKeyF4 := SetKey( VK_F4 , Nil )
SetKey( VK_F4 , { || oDlg1:End() } )

//Painel dos Botoes para Manutencoes=============================================================================
//oPanBotoes:=TPanel():New(5,5,,oC1W1,/*[aoFont]*/,,,/*CorTexto*/,CLR_GREEN,290,15,.T.,.T.) 
//oPanBotoes:ALIGN:= CONTROL_ALIGN_LEFT

//BOTOES=========================================================================================================
oButt1:= FWButtonBar():new()											
oButt1:Init(oC1W1, 17, 20,CONTROL_ALIGN_TOP, .T. )   

oButt1:addBtnImage( "final"		,"Sair"					,{|| oDlg1:End()}					,,.T.,CONTROL_ALIGN_RIGHT)  
oButt1:addBtnImage( "S4WB001N"	,"Incluir"				,{|| U_QA040TELA(,,3,.T.,@oDlg1)}	,,.T.,CONTROL_ALIGN_RIGHT) 
oButt1:addBtnImage( "NOTE"		,"Alterar Contrato"		,{|| Altera(1) 	}					,,.T.,CONTROL_ALIGN_RIGHT) 
oButt1:addBtnImage( "S4WB007N"	,"Alt.Nome Contr."		,{|| Altera(3) 	}					,,.T.,CONTROL_ALIGN_RIGHT) 
oButt1:addBtnImage( "SIMULACA"	,"Revisao"				,{|| Altera(2) 	}					,,.T.,CONTROL_ALIGN_RIGHT) 
oButt1:addBtnImage( "EXCLUIR"	,"Encerramento"			,{|| Altera(4) 	}					,,.T.,CONTROL_ALIGN_RIGHT) 
oButt1:addBtnImage( "PRECO"		,"Nota Fiscal"			,{|| If(!empty(cNota).and.!Empty(cSerie).and.!Empty(cXFilial),xDanfe(cXFilial),MsgStop("Insira o numero da Filial, Nota e Serie!")) }			,,.T.,CONTROL_ALIGN_RIGHT)
//oButt1:addBtnImage( "cargaseq"	,"Relatorio Contratos"	,{|| U_QUAR080W()}			,,.T.,CONTROL_ALIGN_RIGHT)
oButt1:addBtnImage( "S4WB009N"	,"Planilha Contratos"	,{|| U_QUAR090W()}			,,.T.,CONTROL_ALIGN_RIGHT) 

//oButt1:addBtnImage( "PRECO"		,"Nota Fiscal"			,{|| xVerDesc()()	}			,,.T.,CONTROL_ALIGN_RIGHT)

//==COMBO 1 - STATUS=============================================================================================
cFilCmb1 := ""
aOrdCmb1 := {} 
AADD(aOrdCmb1,"A=ATIVOS")
AADD(aOrdCmb1,"I=INATIVOS")
AADD(aOrdCmb1,"T=TODOS")

@003,001 COMBOBOX oCBX1 VAR cFilCmb1 ITEMS aOrdCmb1 SIZE 80,10 PIXEL OF oC1W1 FONT oFont2 COLOR CLR_BLUE;
ON CHANGE LoadContr(.T.)
oCBX1:Refresh()

//==COMBO 2 - FILIAL=============================================================================================
cFilCmb2 := ""
aOrdCmb2 := QA80FIL() 
@003,085 COMBOBOX oCBX2 VAR cFilCmb2 ITEMS aOrdCmb2 SIZE 110,10 PIXEL OF oC1W1 FONT oFont2 COLOR CLR_BLUE;
ON CHANGE LoadContr(.T.)
oCBX1:Refresh()

//==COMBO 3 - CATEGORIA PRODUTO===================================================================================
cFilCmb3 := ""
aOrdCmb3 := QA80SX5() 
@004+15,001 COMBOBOX oCBX3 VAR cFilCmb3 ITEMS aOrdCmb3 SIZE 150,10 PIXEL OF oC1W1 FONT oFont2 COLOR CLR_BLUE ;
ON CHANGE LoadContr(.T.)
oCBX1:Refresh()

//==PRODUTO=======================================================================================================
@006+15,330+20-198 SAY "Produto.:"	SIZE 048,10 OF oC1W1 	PIXEL FONT oFont2 COLOR CLR_RED  
@003+15,380+20-198 MSGET oCodPro 	VAR cCodPro	SIZE 060,10 OF oC1W1 	PIXEL FONT oFont2 COLOR CLR_BLUE WHEN .T. F3 "SB1ZZN";
Valid Iif(Empty(cCodPro),.T.,iif( (ExistCpo("SB1",cCodPro) .OR. Empty(cCodPro)),cProd := Posicione("SB1",1,xFilial("SB1")+cCodPro,"B1_DESC"),cProd := "" ))  PICTURE "@!" ;
ON CHANGE LoadContr(.T.,"cCodPro")
@003+15,440+23-198 MSGET oProd 	VAR cProd	SIZE 200,10 OF oC1W1 WHEN .F. PIXEL FONT oFont5 COLOR CLR_BLUE WHEN .T.

//==CLIENTE=======================================================================================================
@020+18,090-089 SAY "Cliente:"		SIZE 040,10 OF oC1W1 	PIXEL FONT oFont2 COLOR CLR_BLUE  
@017+18,130-089 MSGET oCodCli 	VAR cCodCli	SIZE 030,10 OF oC1W1 	PIXEL FONT oFont2 COLOR CLR_BLUE WHEN .T. F3 "SA1";
Valid Iif(Empty(cCodCli),.T.,iif( (ExistCpo("SA1",cCodCli) .OR. Empty(cCodCli)),cCliente := Substr(Posicione("SA1",1,xFilial("SA1")+cCodCli,"A1_NOME"),1,33),cCliente := "" ))  PICTURE "@!" ; 
ON CHANGE If(LoadContr(.T.,"cCodCli"),.T.,VerBand())
//==LOJA==========================================================================================================
@020+18,188-087 SAY "Loja:" SIZE 030,10 OF oC1W1 	PIXEL FONT oFont2 COLOR CLR_BLUE  
@017+18,215-087 MSGET oCodLoja 	VAR cLojaCli	SIZE 018,10 OF oC1W1 	PIXEL FONT oFont2 COLOR CLR_BLUE WHEN .T. ;
Valid Iif(Empty(cLojaCli),.T.,iif( (ExistCpo("SA1",cCodCli+cLojaCli) .OR. Empty(cLojaCli)),cCliente := SubStr(Posicione("SA1",1,xFilial("SA1")+cCodCli+cLojaCli,"A1_NOME"),1,33),cCliente := "" ))  PICTURE "@!"; 
ON CHANGE if(LoadContr(.T.,"cLojaCli"),.T.,VerBand())
@017+18,215-089+55 MSGET oCliente 	VAR cCliente	SIZE 167,10 OF oC1W1 WHEN .F.	PIXEL FONT oFont5 COLOR CLR_BLUE WHEN .T.

//==BANDEIRA======================================================================================================
@020+18,330+20 SAY "Bandeira:" SIZE 060,10 OF oC1W1 PIXEL FONT oFont2 COLOR CLR_GREEN  
@017+18,380+20 MSGET oBand 	VAR cBand	SIZE 060,10 OF oC1W1 	PIXEL FONT oFont2 COLOR CLR_BLUE F3 "SX5BA" WHEN .T. ;
Valid Iif(Empty(cBand),.T.,iif( (ExistCpo("ZAP",cBand) .OR. Empty(cBand)),cDBand := Posicione("ZAP",1,xFilial("ZAP")+cBand,"ZAP_DESCR"),cDBand := "" )) PICTURE "@!"; 
ON CHANGE LoadContr(.T.,"cBand") 
@017+18,440+23 MSGET oDBand 	VAR cDBand	SIZE 200,10 OF oC1W1 WHEN .F. PIXEL FONT oFont5 COLOR CLR_BLUE

//==NOTA FISCAL====================================================================================================

@035+20,090-089 SAY "Filial..:" SIZE 060,10 OF oC1W1 PIXEL FONT oFont2 COLOR CLR_BROWN  
@032+20,130-089 MSGET oFilial VAR cXFilial	SIZE 010,10 OF oC1W1 	PIXEL FONT oFont2 COLOR CLR_BLUE WHEN .T. ;
ON CHANGE LoadContr(.T.,"cXFilial")

@035+20,70+090-089 SAY "Nota....:" SIZE 060,10 OF oC1W1 PIXEL FONT oFont2 COLOR CLR_BROWN  
@032+20,70+130-089 MSGET oNota 	VAR cNota	SIZE 030,10 OF oC1W1 	PIXEL FONT oFont2 COLOR CLR_BLUE WHEN .T. ;
ON CHANGE LoadContr(.T.,"cNota")
//Valid Iif(Empty(cBand),.T.,iif( (ExistCpo("SX5","BA"+cBand) .OR. Empty(cBand)),cDBand := Posicione("SX5",1,xFilial("SXE")+"BA"+cBand,"X5_DESCRI"),cDBand := "" )) PICTURE "@!" 

@035+20,70+188-069 SAY "Serie:" SIZE 060,10 OF oC1W1 PIXEL FONT oFont2 COLOR CLR_BROWN  
@032+20,70+215-066 MSGET oSerie 	VAR cSerie	SIZE 030,10 OF oC1W1 	PIXEL FONT oFont2 COLOR CLR_BLUE WHEN .T. ;
ON CHANGE LoadContr(.T.,"cSerie")
//Valid Iif(Empty(cBand),.T.,iif( (ExistCpo("SX5","BA"+cBand) .OR. Empty(cBand)),cDBand := Posicione("SX5",1,xFilial("SXE")+"BA"+cBand,"X5_DESCRI"),cDBand := "" )) PICTURE "@!" 

@035+20,100+330+70-198 SAY "Nome Contrato:" SIZE 110,10 OF oC1W1 PIXEL FONT oFont2 COLOR CLR_HBLUE   
@032+20,100+420+65-198 MSGET oNomCtr 	VAR cNctr	SIZE 200,10 OF oC1W1 PIXEL FONT oFont2 COLOR CLR_BLUE PICTURE "@!" WHEN .T. ;
ON CHANGE LoadContr(.T.,"cNctr")

//JANELA 2====================================================================================================================================================================

//oFWLayer:addCollumn("Col01",45,.F.,"Lin01")
oFWLayer:addWindow( "Col01", "Win02", "CONTRATOS",50, .T., .F.,,"Lin01")
oC1W2:= oFWLayer:getWinPanel( "Col01", "Win02","Lin01")  

//LISTBOX ITENS======================================================================================================
@ 01,01 LISTBOX oItens1 Fields HEADER "S","CONTRATO","DESCRICAO                     ","REVISAO","DT.INICIAL","DT.FINAL","ATIVO?","FILIAIS";
SIZES {04,10,10,05,05,05,05,60} SIZE 490,095 PIXEL of oC1W2 FONT oFont6 ;
ON CHANGE LoadItens(.T.)
//ON DBLCLICK Lin_OnOff(oPedido,aPedidos,oBroItp,lHist,oDesbloq,oSaldoPed);
LoadContr(.F.)
oItens1:Align := CONTROL_ALIGN_ALLCLIENT 
oItens1:Refresh()

//JANELA 3====================================================================================================================================================================
oFWLayer:addLine ("Lin02",40,.F.)
oFWLayer:addCollumn("Col02",40,.F.,"Lin02")
oFWLayer:addWindow( "Col02", "Win02", "ITENS CONTRATOS", 100, .T., .F.,,"Lin02")
oC1W3:= oFWLayer:getWinPanel( "Col02", "Win02","Lin02")  

aCab := xCabZC5()
aItem := {}    
oItens := MsNewGetDados():New(001,;                //nTop      - Linha Inicial
                                001,;                //nLeft     - Coluna Inicial
                                095,;     			 //nBottom   - Linha Final
                                255,;     			 //nRight    - Coluna Final
                                ,;			 		//nStyle    - Estilos para edi��o da Grid (GD_INSERT = Inclus�o de Linha; GD_UPDATE = Altera��o de Linhas; GD_DELETE = Exclus�o de Linhas)
                                "",;    //cLinhaOk  - Valida��o da linha
                                ,;                   //cTudoOk   - Valida��o de todas as linhas
                                "",;                 //cIniCpos  - Fun��o para inicializa��o de campos
                                ,;  				 //aAlter    - Colunas que podem ser alteradas
                                ,;                   //nFreeze   - N�mero da coluna que ser� congelada
                                9999,;               //nMax      - M�ximo de Linhas
                                ,;                   //cFieldOK  - Valida��o da coluna
                                ,;                   //cSuperDel - Valida��o ao apertar '+'
                                ,;                   //cDelOk    - Valida��o na exclus�o da linha
                                oC1W3,;            	 //oWnd      - Janela que � a dona da grid
                                aCab,;           	 //aHeader   - Cabe�alho da Grid
                                aItem)

//LISTBOX ITENS======================================================================================================
//@ 01,01 LISTBOX oItens Fields HEADER "VERBA","DESCRICAO","CALC","FORMA"," % ","CONS.DEV?";
//SIZES {04,04,04,04,04,04,04} SIZE 490,095 PIXEL of oC1W3 FONT oFont6 //  ;
//ON DBLCLICK Lin_OnOff(oPedido,aPedidos,oBroItp,lHist,oDesbloq,oSaldoPed);
//ON CHANGE U_xRodape( aPedidos[oPedido:nAT,3] )
//LoadContr(.F.)
//oItens:Align := CONTROL_ALIGN_ALLCLIENT 

oItens:Refresh()
//JANELA 4===============================================================================================================================================
oFWLayer:addCollumn("Col03",60,.F.,"Lin02")
oFWLayer:addWindow( "Col03", "Win03", "RELACAO CLIENTE X CONTRATO X CATEGORIA", 100, .T., .F.,,"Lin02")
oC1W4:= oFWLayer:getWinPanel( "Col03", "Win03","Lin02")  

//LISTBOX ITENS======================================================================================================
//ZC7_ITEM	ZC7_CODCTR	BANDEIRA	ZC7_CODCLI	ZC7_LOJA	CLIENTE	PRODUTO	CATEGORIA	MARCA
//@ 01,01 LISTBOX oItens2 Fields HEADER "BANDEIRA","CODCLI","LOJA","CLIENTE","PRODUTO","CATEGORIA","MARCA";
//SIZES {04,04,04,04,04,04,04} SIZE 490,095 PIXEL of oC1W4 FONT oFont6  ;
//ON DBLCLICK Lin_OnOff(oPedido,aPedidos,oBroItp,lHist,oDesbloq,oSaldoPed);
//ON CHANGE U_xRodape( aPedidos[oPedido:nAT,3] )

aHead := {}
aAdd(aHead, {"BANDEIRA"	, "BANDEIRA",  "@!", 006, 0, ".T.", ".T.", "C", "",    "",,,,"V"} )
aAdd(aHead, {"CODCLI"	, "CODCLI",  "@!", 006, 0, ".T.", ".T.", "C", "",    "",,,,"V"} )
aAdd(aHead, {"LOJA"		, "LOJA",  "@!", 006, 0, ".T.", ".T.", "C", "",    "",,,,"V"} )
aAdd(aHead, {"CLIENTE"	, "CLIENTE",  "@!", 018, 0, ".T.", ".T.", "C", "",    "",,,,"V"} )
aAdd(aHead, {"PRODUTO"	, "PRODUTO",  "@!", 018, 0, ".T.", ".T.", "C", "",    "",,,,"V"} )
aAdd(aHead, {"CATEGORIA", "CATEGORIA",  "@!", 010, 0, ".T.", ".T.", "C", "",    "",,,,"V"} )
aAdd(aHead, {"MARCA"	, "MARCA",  "@!", 010, 0, ".T.", ".T.", "C", "",    "",,,,"V"} )
aCols := {}    
oItens2 := MsNewGetDados():New(001,;                //nTop      - Linha Inicial
                                001,;                //nLeft     - Coluna Inicial
                                095,;     			 //nBottom   - Linha Final
                                385,;     			 //nRight    - Coluna Final
                                ,;			 		//nStyle    - Estilos para edi��o da Grid (GD_INSERT = Inclus�o de Linha; GD_UPDATE = Altera��o de Linhas; GD_DELETE = Exclus�o de Linhas)
                                "",;    //cLinhaOk  - Valida��o da linha
                                ,;                   //cTudoOk   - Valida��o de todas as linhas
                                "",;                 //cIniCpos  - Fun��o para inicializa��o de campos
                                ,;  				 //aAlter    - Colunas que podem ser alteradas
                                ,;                   //nFreeze   - N�mero da coluna que ser� congelada
                                9999,;               //nMax      - M�ximo de Linhas
                                ,;                   //cFieldOK  - Valida��o da coluna
                                ,;                   //cSuperDel - Valida��o ao apertar '+'
                                ,;                   //cDelOk    - Valida��o na exclus�o da linha
                                oC1W4,;            	 //oWnd      - Janela que � a dona da grid
                                aHead,;           	 //aHeader   - Cabe�alho da Grid
                                aCols)

//oItens2:Align := CONTROL_ALIGN_ALLCLIENT 
//oItens2:Refresh()


//==PAINEL TOTALIZADOR RODAPE ========================================================================================
oPanRoda 		:= TPanel():New(1,3,,oDlg1,oFont2,,,/*CorTexto*/,/*CLR_GREEN*/,80,15,.T.,.T.) 
oPanRoda:ALIGN 	:= CONTROL_ALIGN_BOTTOM 

@004.3,005 SAY "Contrato:"	SIZE 060,10 OF oPanRoda 	PIXEL FONT oFont2 COLOR CLR_RED 
@2.0,060 MSGET oPedRoda 	VAR cPedRoda	SIZE 060,10 OF oPanRoda WHEN .F. PIXEL FONT oFont2

@004.3,130 SAY "% Desconto:"	SIZE 100,10 OF oPanRoda 		PIXEL FONT oFont2 COLOR CLR_RED  
@2.0,200 MSGET oValPed 	VAR nValPed	SIZE 080,10 OF oPanRoda WHEN .F. PIXEL FONT oFont2 PICTURE "@E 99.99%" 

//@004.3,285 SAY "Kgs Pedido:"	SIZE 100,10 OF oPanRoda 		PIXEL FONT oFont2 COLOR CLR_RED  
//@2.0,350 MSGET oKgsPed 	VAR nKgsPed	SIZE 080,10 OF oPanRoda WHEN .F.  PIXEL FONT oFont2 PICTURE "@E 99,999.999" 

//*@2.0,165 MSGET ocodPedido 	VAR cPedAtu	SIZE 060,10 OF oC1W1 	PIXEL FONT oFont2;
//* When libera //Valid VldPedido(oPasta:nOption,oPedido,oBroItp,cPedAtu,lHist,oDesbloq) PICTURE "@!"   //NO BORDER 

//*@005,005 CHECKBOX oHist		VAR lHist PROMPT "Mostrar Liberados" SIZE 110,7  OF oC1W1 	PIXEL FONT oFont2 COLOR CLR_BLUE //;
//ON CLICK Atualizar(oPasta:nOption,oPedido,oBroItp,cPedAtu,lHist,oDesbloq,oSaldoPed) 

//*@004.3,235 SAY "Emiss�o de:"	SIZE 070,10 OF oC1W1 	PIXEL FONT oFont2 COLOR CLR_BLUE  

//*@2.0,305 MSGET oDataDe 	VAR dDataDe	SIZE 070,10 OF oC1W1 	PIXEL FONT oFont2 //; 
//valid IIF(lHist,Atualizar(oPasta:nOption,oPedido,oBroItp,cPedAtu,lHist,oDesbloq,oSaldoPed),.T.) PICTURE "@E 99/99/9999" 


//*@28.0,140 COMBOBOX oCBX1 VAR cFilBloq1 ITEMS aOrd1 SIZE 80,03 PIXEL OF oC1W1 //FONT oDlg1:oFont
//oCbx1:bChange := {|| nOrd := oCbx1:nAt,Atualizar(oPasta:nOption,oPedido,oBroItp,"",lHist,oDesbloq,oSaldoPed,.T.)}
//oCBX1:ALIGN:= CONTROL_ALIGN_RIGHT
//*oCBX1:Refresh()


//Painel Principal dos Botoes para as Manuten��es e Pesquisa
//oPanPri	:=TPanel():New(1,3,,oC1W1,oFont2,,,/*CorTexto*/,/*CLR_GREEN*///,80,15,.T.,.T.) 
//oPanPri :ALIGN:= CONTROL_ALIGN_TOP 


//Painel para Pesquisa do Pedido
//oPanped	:=TPanel():New(1,3,,oC1W1,oFont2,,,/*CLR_BLUE*/,/*CLR_BLUE*/,380,15,.f.,.f.) //200,07 
//oPanped:ALIGN := CONTROL_ALIGN_RIGHT  





//@ 01,01 LISTBOX oSaldoPed FIELDS HEADER "S","Pedido","Cliente","Estado","Cidade","Cep","Data do Pedido","Data Desbloqueio", "Horario Liberacao","Observa��o"," " ;
//SIZES {05,20,20,20,20,20,20,20,20,35,02} SIZE 490,095 OF oPasta:aDialogs[3] PIXEL ;	
//ON DBLCLICK AtItemSdo(aSaldoPed[oSaldoPed:nAT,2],oBroItp)
//oSaldoPed:Align := CONTROL_ALIGN_ALLCLIENT  //nOption,oBroItp,cPedido
//oSaldoPed:Refresh()

//Painel para Filtro dos Bloqueios============================================================================================================================== 





//========================================================================================================================================================================

//========================================================================================================================================================================
/*
CB1->(DbSetOrder(2)) // Filial+Codigo Usuario Protheus 
cOperador := __cUserID 
If !CB1->(DBSeek(xFilial("CB1") + Padr(cOperador,6)))
	CBAlert("Operador Invalido.")
	Return .F.
Endif

If Alltrim(CB1->CB1_ROTINA) $ 'ADMIN' //Filial Sao Paulo
	oButt1:addBtnImage( "btcalend",	"Roteiro",	  			{|| CadRoteiro ()} 												   		   							,,.T.,CONTROL_ALIGN_LEFT) 
	oButt1:addBtnImage( "nco",	   	"Cadastro de Bloqueio",	{|| U_NMCB53A()} 					   				   												,,.T.,CONTROL_ALIGN_LEFT)   
	oButt1:addBtnImage( "GPEIMG32",	"Usuarios",				{|| CadUsuario(oPasta:nOption,oPedido,oBroItp,lHist,oDesbloq,oCBX1)}	   					,,.T.,CONTROL_ALIGN_LEFT) 
	oButt1:addBtnImage( "folder14",	"Parametros", 	   		{|| AtuParamet()}		   			   													  			,,.T.,CONTROL_ALIGN_LEFT)  
	oButt1:addBtnImage( "DESTINOS",	"Cad.TranspxDias Lib.",	{|| U_AXCADPX9() }		,,.T.,CONTROL_ALIGN_LEFT)
Endif

oButt1:addBtnImage( "svm", 			"Legenda", 	   			{|| FS53legPed(1,oPasta)}			   				   			   		   				  			,,.T.,CONTROL_ALIGN_LEFT)
oButt1:addBtnImage( "PRECO", 		"Pos.Financeira", 		{|| xPosCli(oPedido) }	,,.T.,CONTROL_ALIGN_LEFT)
oButt1:addBtnImage( "cargaseq",	"Imprime Pedidos", 			{|| U_RELPEDBL() }		,,.T.,CONTROL_ALIGN_LEFT)
oButt1:addBtnImage( "carganew",	"Imprime Cortes", 			{|| U_RELACORTE() }		,,.T.,CONTROL_ALIGN_LEFT)
oButt1:addBtnImage( "TK_VERTIT",	"Imprime Posicao Pedidos",	{|| U_RPEDBLFAT() }		,,.T.,CONTROL_ALIGN_LEFT)
oButt1:addBtnImage( "EXCLUIR",	"Excluir Pedido",  		{|| DelPedido(cFilAnt,aPedidos[oPedido:nAT,3]),Atualizar(oPasta:nOption,oPedido,oBroItp,"",lHist,oDesbloq,oSaldoPed) },,.T.,CONTROL_ALIGN_LEFT)
//DelPedido(cFilAnt,aPedidos[oPedido:nAT,3])
*/
//
//RELACORTE
//PAINEIS PRINCIPAIS
//oPasta:= TFolder():New(000,000,{"PEDIDOS","DESBLOQUEIOS DO PEDIDO","BLOQUEIOS POR VALOR MINIMO"},{},oC1W1 ,,,,.T.,.F.,392,244,)//392,244
//oPasta 			:= TFolder():New(000,000,{" P E D I D O S ","H I S T O R I C O   D E S B L O Q U E I O S","PEDIDOS GERADOS DE SALDO (C O R T E)"},{},oC1W1 ,,,,.T.,.F.,392,244,)//392,244
//oPasta 			:= TFolder():New(000,000,{"V E R B A S"},{},oC1W1 ,,,,.T.,.F.,392,244,)//392,244
//oPasta:align 	:= CONTROL_ALIGN_ALLCLIENT
//oPasta:bChange 	:= {|| Atualizar(oPasta:nOption,oPedido,oBroItp,"",lHist,oDesbloq,oSaldoPed)}


//DESBLOQUEIOS DO PEDIDO======================================================================================================================================
//@ 01,01 LISTBOX oDesbloq FIELDS HEADER "S","Pedido","Cod.Bloqueio","Bloqueio Registrado","Data Desbloqueio", "Horario Desbloqueio","Observa��o","Responsavel"," " ;
//SIZES {02,20,10,30,20,20,20,30,02} SIZE 490,095 PIXEL	 OF oPasta:aDialogs[2] 
//oDesbloq:Align := CONTROL_ALIGN_ALLCLIENT  //nOption,oBroItp,cPedido
//oDesbloq:Refresh()

//ALTERACAO ITENS PEDIDO =================================================================================================================================

//Relacao dos ITENS ;;;;; oSt,C6_ITEM,C6_PRODUTO,cDescProd,C6_QTDVEN,C6_QUANTLI,C6_PRCVEN,C6_VALOR
//@ 01,01 LISTBOX oBroItp1 FIELDS HEADER ;
//"S","PEDIDO","IT","CODPRO","PRODUTO","CLIENTE","CIDADE","EST","ARM","QTD.PED","SEG.UM","QTD.LIB","VR.UNIT","VR.TAB","TOTAL","REPRESENTANTE", " " ;
//SIZES {5,6,2,6,35,70,15,10,10,10,15,15,15,10,10,2} SIZE 550,100 OF oPasta:aDialogs[3] PIXEL ON DBLCLICK cEditArm(oBroItp1)
//oBroItp1:align := CONTROL_ALIGN_ALLCLIENT
//oBroItp1:Refresh()
//LoadSC6 (oBroItp1,'001001')




//COLUNA1 - JANELA 2 =====================================================================================================================================

//oFWLayer:addWindow( "Col01", "Win02", "RELA��O DOS ITENS", 50, .T., .f. )
//oC1W2	:= oFWLayer:getWinPanel( "Col01", "Win02")   

//Relacao dos ITENS ;;;;; oSt,C6_ITEM,C6_PRODUTO,cDescProd,C6_QTDVEN,C6_QUANTLI,C6_PRCVEN,C6_VALOR
//@ 01,01 LISTBOX oBroItp FIELDS HEADER ;
//"S","PEDIDO","IT","CODPRO","PRODUTO","QTD.PED","SEG.UM","QTD.LIB","VR.UNIT","VR.TAB", "TOTAL","ARM","REPRESENTANTE", " " ;
//SIZES {5,6,2,30,15,10,10,15,15,15,10,10,2} SIZE 550,100 OF oC1W2 PIXEL ON DBLCLICK IIF(!lHist,xMat460(oBroItp,oPedido,lHist,oDesbloq,oSaldoPed),.T.)

//oBroItp:align := CONTROL_ALIGN_ALLCLIENT

//====================================================================================================================


//If lfirst
//	Atualizar(oPasta:nOption,oPedido,oBroItp,"",lHist,oDesbloq,oSaldoPed,.T.)
//	lfirst := .F.
//Endif

ACTIVATE MSDIALOG oDlg1 

SET KEY VK_F4 TO

Return 

/*/
��������������������������������������������������������������������������������
��������������������������������������������������������������������������������
����������������������������������������������������������������������������Ŀ��
���Fun��o    �Monta_SC6	 � Autor � Luiz Enrique	         � Data � 15/09/2014 ���
����������������������������������������������������������������������������Ĵ��
���Descri��o � Monta a Lista dos ITENS dos pedidos Bloqueados 				 ���
�����������������������������������������������������������������������������ٱ�
��������������������������������������������������������������������������������
��������������������������������������������������������������������������������*/
Static Function LoadContr(lCombo,cCampo)

Local oSt			:= LoadBitmap(GetResources(),'BR_VERDE') 
Local oSt2			:= LoadBitmap(GetResources(),'BR_VERMELHO')    
Local aBloqs		:= {} 
Local cDescProd		:= ""
Local nLiberado		:= 0
Local nTotValIt		:= 0 
Local lCorte		:= .F.
Local cQuery		:= ''
Local xFil			:= ""
Local cStatus		:= IIF(SubStr(cFilCmb1,1,1)=="A","S","N")
Local lAchou		:= .T.

Default cCampo := ""

If cCampo $ "cCodCli|cLojaCli"

	cBand  		:= Space(TamSx3("A1_COD")[1])   
	cDBand		:= Space(45)
	cNota		:= Space(9)
	cSerie		:= Space(3)
	cNctr 		:= Space(200)
	cXFilial	:= Space(2)
	
	oBand:Refresh()
	oDBand:Refresh()
	oProd:Refresh()
	oNota:Refresh()
	oSerie:Refresh()
	oFilial:Refresh()
	oNomCtr:Refresh()


ElseIf cCampo == "cBand"

	cCodCli  	:= Space(TamSx3("A1_COD")[1])   
	cLojaCli 	:= Space(TamSx3("A1_LOJA")[1])
	cCliente	:= Space(45)
	cNota		:= Space(9)
	cSerie		:= Space(3)
	cNctr 		:= Space(200)
	cXFilial	:= Space(2)
	
	oCodCli:Refresh()
	oCodLoja:Refresh()
	oCodPro:Refresh()
	oCliente:Refresh()
	oNota:Refresh()
	oSerie:Refresh()
	oFilial:Refresh()
	oNomCtr:Refresh()

	
ElseIf cCampo $ "cNota|cSerie|cXFilial"

	cCodCli  	:= Space(TamSx3("A1_COD")[1])   
	cLojaCli 	:= Space(TamSx3("A1_LOJA")[1])
	cBand  		:= Space(TamSx3("A1_COD")[1])   
	cDBand		:= Space(45)
	cCliente	:= Space(45)
	cNctr 		:= Space(200)

	oCodCli:Refresh()
	oCodLoja:Refresh()
	oBand:Refresh()
	oDBand:Refresh()
	oProd:Refresh()
	oCliente:Refresh()
	oNomCtr:Refresh()


ElseIf cCampo == "cNctr"

	cCodCli  	:= Space(TamSx3("A1_COD")[1])   
	cLojaCli 	:= Space(TamSx3("A1_LOJA")[1])
	cBand  		:= Space(TamSx3("A1_COD")[1])   
	cDBand		:= Space(45)
	cCliente	:= Space(45)
	cNota		:= Space(9)
	cSerie		:= Space(3)
	cXFilial	:= Space(2)
	
	oCodCli:Refresh()
	oCodLoja:Refresh()
	oBand:Refresh()
	oDBand:Refresh()
	oProd:Refresh()
	oCliente:Refresh()
	oNota:Refresh()
	oSerie:Refresh()
	oFilial:Refresh()
End If

aItens1 := {}

		If SubStr(cFilCmb2,1,2) <> "00"
			xFil := SubStr(cFilCmb2,1,2)
		End If
	
	If !Empty(cNota)
	
		cCodCon 	:= ''
		nRevisao	:= ''
		
		dbSelectArea("SF2")
		dbSetOrder(1)
		MsSeek(cXFilial+cNota+cSerie,.T.)
		
		dbSelectArea("SD2")
		dbSetOrder(3)
	
		If MsSeek(cXFilial+cNota+cSerie,.T.)
			xPerd := 0
			While !Eof()  .And. cXFilial+cNota+cSerie == SD2->D2_FILIAL+SD2->D2_DOC+SD2->D2_SERIE
				xPerd += U_QUAA060W(5,SD2->D2_CLIENTE,SD2->D2_LOJA,'1',SD2->D2_EMISSAO,SD2->D2_COD,,,,,,,@cCodCon,@nRevisao,.T.)
				         //U_QUAA060W(5,SD2->D2_CLIENTE,SD2->D2_LOJA,'1',SD2->D2_EMISSAO,SD2->D2_COD)
				//MsgAlert(cCodCon+"-"+nRevisao+ " - " + cValToChar(xPerd))
				dbSkip()
			EndDo
		
		End If
		
		cQuery := "SELECT DISTINCT ZC4_CODCON,ZC4_OBSOLE,ZC4_DESC,ZC4_REVISA,ZC4_DTINI,ZC4_DTFIM,ZC4_ATIVO,ZC4_FILSEL " + CRLF
		cQuery += " FROM " + RetSqlName("ZC4") + " ZC4 " + CRLF
		//cQuery += " WHERE ZC4.D_E_L_E_T_=''  AND ZC4_CODCON+ZC4_REVISA IN (SELECT E1_XNCONTR+E1_NREVISC FROM SE1010 WHERE E1_FILIAL='" + cXFilial + "' AND E1_NUM='" + cNota + "' AND E1_SERIE='" + cSerie + "' AND E1_TIPO='NF') " + CRLF
		cQuery += " WHERE ZC4.D_E_L_E_T_=''  AND ZC4_CODCON='" + cCodCon + "' AND ZC4_REVISA='" + nRevisao + "'" + CRLF
	
	
	Else

	cQuery := "SELECT DISTINCT ZC4_CODCON,ZC4_OBSOLE,ZC4_DESC,ZC4_REVISA,ZC4_DTINI,ZC4_DTFIM,ZC4_ATIVO,ZC4_FILSEL " + CRLF
	cQuery += " FROM " + RetSqlName("ZC4") + " ZC4 " + CRLF
	cQuery += " INNER JOIN " + RetSqlName("ZC7") + " ZC7 ON ZC7_CODCTR=ZC4_CODCON AND ZC7.D_E_L_E_T_=''
	
	cQuery += " WHERE ZC4.D_E_L_E_T_=''   " + CRLF
	
	If SubStr(cFilCmb3,1,6) <> "999999" .AND. Empty(cCodPro)
		cQuery += " AND ZC7_CATEGO = '" + SubStr(cFilCmb3,1,6) + "' " + CRLF
	End If
	
	If !Empty(cCodpro)
		cQuery += " AND ZC7_CODPRO = '" + cCodPro + "' " + CRLF
	End If

	If !Empty(cCodCli)
		cQuery += " AND ZC7_CODCLI = '" + cCodCli + "'" + CRLF//+ "' AND ZC7_LOJA = '" + cLojaCli + "'" + CRLF
	End If
	
	If !Empty(cLojaCli)
		cQuery += " AND ZC7_LOJA = '" + cLojaCli + "' " + CRLF
	End If

	If !Empty(cBand) .AND. Empty(cCodCli)
		cQuery += " AND ZC7_BANDEI = '" + cBand + "' " + CRLF
	End If
	
	If !Empty(cNctr) 
		cQuery += " AND ZC4_DESC LIKE '%" + Alltrim(cNctr) + "%' " + CRLF
	End If
	
	
	If SubStr(cFilCmb2,1,2) <> "00"
		cQuery += " AND ZC4_FILSEL LIKE ('%" + SubStr(cFilCmb2,1,2) + "%') " + CRLF
	End If
	
	If SubStr(cFilCmb1,1,1)=="A"
		cQuery += " AND ZC4_OBSOLE='F' " + CRLF  
	ElseIf SubStr(cFilCmb1,1,1)=="I"
		cQuery += " AND ZC4_OBSOLE='T' " + CRLF
	End If
	
	If !Empty(cBand)
		cQuery += " AND ZC4_CODCON IN (SELECT ZC7_CODCTR FROM " + RetSqlName("ZC7") + " ZC7 WHERE ZC7_BANDEI = '" + cBand + "' AND ZC7.D_E_L_E_T_='') " + CRLF
	End If
	
	cQuery += " ORDER BY ZC4_CODCON,ZC4_REVISA " + CRLF
	
	End If
	
	MemoWrite("C:\HD\Arq Trabalho\NOVAMIX\ACD\QUERYS\CONTRATOS.SQL",cQuery)
			
	IF Select("QUAA080W") > 0
		QUAA080W->(dbCloseArea())
	EndIf
	
	TCQUERY cQuery NEW ALIAS "QUAA080W" 
	
	If QUAA080W->(Eof()) .AND. !Empty(cCodCli)
		lAchou	:= .F.	
	End If
		
	
	While QUAA080W->(!Eof())
		
		Aadd(aItens1,{Iif(QUAA080W->ZC4_OBSOLE == "F",oSt,oSt2),; 
					QUAA080W->ZC4_CODCON,;
					QUAA080W->ZC4_DESC,;
			 		QUAA080W->ZC4_REVISA,;
			 		stod(QUAA080W->ZC4_DTINI),;
			 		stod(QUAA080W->ZC4_DTFIM),;
			 		IIF(QUAA080W->ZC4_OBSOLE == 'F',"S","N"),;
			 		QUAA080W->ZC4_FILSEL,;
					," "})										 
		
		QUAA080W->( dbSkip() )

	End While 

//04,10,60,40,30,30,30
//@ 01,01 LISTBOX oItens Fields HEADER "CONTRATO","DESCRICAO","REVISAO","DT.INICIAL","DT.FINAL","ATIVO?","FILIAIS";
//SIZES {04,10,60,05,10,10,10,30} SIZE 490,095 PIXEL of oC1W2//  ;

If Empty(aItens1)                                
	aItens1 := {{oSt,Space(10),Space(35),Space(05),Space(10),Space(10),Space(10),Space(10),Space(30)," "}}
EndIf

//"S","Item","Produto","Descri��o","Quantidade","Qtd. Liberada","Valor Unitario", "Total", "Arm"," "	
oItens1:SetArray(aItens1)
oItens1:bLine := {|| {aItens1[oItens1:nAt,01],aItens1[oItens1:nAt,02],Alltrim(aItens1[oItens1:nAt,03]),aItens1[oItens1:nAt,04],aItens1[oItens1:nAt,05],aItens1[oItens1:nAt,06],;
					aItens1[oItens1:nAt,07],aItens1[oItens1:nAt,08],aItens1[oItens1:nAt,09],aItens1[oItens1:nAt,10]}}						
oItens1:Refresh()

If lCombo
	LoadItens(.T.)
End If

Return lAchou

/*/
��������������������������������������������������������������������������������
��������������������������������������������������������������������������������
����������������������������������������������������������������������������Ŀ��
���Fun��o    �Monta_SC6	 � Autor � Luiz Enrique	         � Data � 15/09/2014 ���
����������������������������������������������������������������������������Ĵ��
���Descri��o � Monta a Lista dos ITENS dos pedidos Bloqueados 				 ���
�����������������������������������������������������������������������������ٱ�
��������������������������������������������������������������������������������
��������������������������������������������������������������������������������*/
Static Function LoadItens(lCombo)

Local oSt			:= LoadBitmap(GetResources(),'BR_VERDE') 
Local oSt2			:= LoadBitmap(GetResources(),'BR_AZUL')    
Local aBloqs		:= {} 
Local cDescProd		:= ""
Local nLiberado		:= 0
Local nTotValIt		:= 0 
Local lCorte		:= .F.
Local cQuery		:= ''

aItens := {}
//Local aItens		:= {}
	//msgalert(cValToChar(nAt))
	cQuery := " SELECT ZC5_ITEM,ZC5_CODCON,ZC5_CODVER,ZC5_DESC,ZC5_PERCEN, " + CRLF
	cQuery += " ZC5_CALCUL, " + CRLF
	cQuery += " ZC5_FORMA, " + CRLF 
	cQuery += " ZC5_DEVOLV " + CRLF
	cQuery += " FROM " + RetSqlName("ZC5") + " ZC5  " + CRLF
	cQuery += " WHERE ZC5.D_E_L_E_T_='' AND ZC5_CODCON='" + oItens1:aArray[oItens1:nAT,02] + "' AND ZC5_REVISA='" + oItens1:aArray[oItens1:nAT,04] + "' " + CRLF
	cQuery += " ORDER BY ZC5_ITEM " + CRLF
	//oPedido:aArray[oPedido:nAT,10]
	MemoWrite("C:\HD\Arq Trabalho\NOVAMIX\ACD\QUERYS\CONTRATOS_ITENS.SQL",cQuery)
			
	IF Select("QUAA080I") > 0
		QUAA080I->(dbCloseArea())
	EndIf
		
	dbUseArea(.T., "TOPCONN", TCGENQRY(,,cQuery), "QUAA080I", .T., .F.)
	cPedRoda := QUAA080I->ZC5_CODCON
	nValPed := 0
	While QUAA080I->(!Eof())
			nValPed += QUAA080I->ZC5_PERCEN
	 		Aadd(aItens,{QUAA080I->ZC5_CODVER,;
					 	SubStr(QUAA080I->ZC5_DESC,1,16),;
					 	QUAA080I->ZC5_CALCUL,;
					 	QUAA080I->ZC5_FORMA,;
					 	QUAA080I->ZC5_PERCEN,;
					 	QUAA080I->ZC5_DEVOLV,;
						,.F.})										 
	
	QUAA080I->( dbSkip() )

End While 

//04,10,60,40,30,30,30
If Empty(aItens)                                
	aItens := {{Space(4),Space(4),Space(4),Space(4),Space(4),Space(4),.F.}}
EndIf

//"S","Item","Produto","Descri��o","Quantidade","Qtd. Liberada","Valor Unitario", "Total", "Arm"," "	
//oItens:SetArray(aItens)
//oItens:bLine := {|| {aItens[oItens:nAt,01],aItens[oItens:nAt,02],aItens[oItens:nAt,03],aItens[oItens:nAt,04],aItens[oItens:nAt,05],aItens[oItens:nAt,06],;
//						aItens[oItens:nAt,07]}}						
//oItens:Refresh()
oItens:aCols := aItens
oItens:ForceRefresh()

If lCombo
	LoadCtrCli()
End If

oPedRoda:Refresh()
oValPed:Refresh()	
	 


Return
/*/
��������������������������������������������������������������������������������
��������������������������������������������������������������������������������
����������������������������������������������������������������������������Ŀ��
���Fun��o    �Monta_SC6	 � Autor � Luiz Enrique	         � Data � 15/09/2014 ���
����������������������������������������������������������������������������Ĵ��
���Descri��o � Monta a Lista dos ITENS dos pedidos Bloqueados 				 ���
�����������������������������������������������������������������������������ٱ�
��������������������������������������������������������������������������������
��������������������������������������������������������������������������������*/
Static Function LoadCtrCli()

Local oSt			:= LoadBitmap(GetResources(),'BR_VERDE') 
Local oSt2			:= LoadBitmap(GetResources(),'BR_AZUL')    
Local aBloqs		:= {} 
Local cDescProd		:= ""
Local nLiberado		:= 0
Local nTotValIt		:= 0 
Local lCorte		:= .F.
Local cQuery		:= ''
Local lAchou		:= .F.

aItens2 := {}

	cQuery := " SELECT ZC7_ITEM,ZC7_CODCTR,ISNULL(ZC7_BANDEI+'-'+(SELECT ZAP_DESCR FROM ZAP010 WHERE D_E_L_E_T_='' AND ZAP_BAND=ZC7_BANDEI),'') AS 'BANDEIRA', " + CRLF
	cQuery += " ZC7_CODCLI,ZC7_LOJA,ISNULL((SELECT TOP 1 A1_NOME FROM SA1010 WHERE D_E_L_E_T_='' AND A1_COD=ZC7_CODCLI),'') AS 'CLIENTE', " + CRLF
	cQuery += " ISNULL(ZC7_CODPRO+'-'+(SELECT B1_DESC FROM  SB1010 WHERE D_E_L_E_T_='' AND B1_COD=ZC7_CODPRO),'') AS 'PRODUTO', " + CRLF
	cQuery += " ISNULL(ZC7_CATEGO+'-'+(SELECT X5_DESCRI FROM SX5010 WHERE D_E_L_E_T_='' AND X5_TABELA='X4' AND X5_CHAVE=ZC7_CATEGO),'') AS 'CATEGORIA', " + CRLF
	cQuery += " ISNULL(ZC7_MARCA+'-'+(SELECT X5_DESCRI FROM SX5010 WHERE D_E_L_E_T_='' AND X5_TABELA='X8' AND X5_CHAVE=ZC7_MARCA),'') AS 'MARCA'  " + CRLF
	cQuery += " FROM ZC7010 ZC7 WHERE ZC7.D_E_L_E_T_=''  " + CRLF
	cQuery += " AND ZC7_CODCTR='" + oItens1:aArray[oItens1:nAT,02] + "' " + CRLF
	
	If Empty(cNota)
	If SubStr(cFilCmb3,1,6) <> '999999' .AND. Empty(cCodPro)
		cQuery += " AND ZC7_CATEGO='" + SubStr(cFilCmb3,1,6) + "'  " + CRLF
	End If
	
	If !Empty(cCodPro)
		cQuery += " AND ZC7_CODPRO='" + cCodpro + "' " + CRLF
	End If
	
	If !Empty(cCodCli)
		cQuery += " AND ZC7_CODCLI='" + cCodCli + "'  " + CRLF
	End If
	
	If !Empty(cLojaCli)
		cQuery += " AND ZC7_LOJA='" + cLojaCli + "'  " + CRLF
	End If
	
	If !Empty(cBand) .AND. Empty(cCodCli)
		cQuery += " AND ZC7_BANDEI='" + cBand + "'  " + CRLF
	End If
	End If
	cQuery += " ORDER BY ZC7_ITEM  " + CRLF
	
	MemoWrite("C:\HD\Arq Trabalho\NOVAMIX\ACD\QUERYS\CONTRATOS_CLIXCONTRATO.SQL",cQuery)
			
	IF Select("QUAA080C") > 0
		QUAA080C->(dbCloseArea())
	EndIf
		
	dbUseArea(.T., "TOPCONN", TCGENQRY(,,cQuery), "QUAA080C", .T., .F.)
	//ZC7_ITEM	ZC7_CODCTR	BANDEIRA	ZC7_CODCLI	ZC7_LOJA	CLIENTE	PRODUTO	CATEGORIA	MARCA
	While QUAA080C->(!Eof())
		
	 		Aadd(aItens2,{SubStr(QUAA080C->BANDEIRA,1,14),;
					 	QUAA080C->ZC7_CODCLI,;
					 	QUAA080C->ZC7_LOJA,;
					 	SubStr(QUAA080C->CLIENTE,1,14),;
					 	SubStr(QUAA080C->PRODUTO,1,14),;
					 	SubStr(QUAA080C->CATEGORIA,1,20),;
					 	SubStr(QUAA080C->MARCA,1,20),;
						,.F.})										 
	
	QUAA080C->( dbSkip() )

EndDo 

//04,10,60,40,30,30,30
If Empty(aItens2)                                
	aItens2 := {{Space(4),Space(4),Space(4),Space(4),Space(4),Space(4),Space(4)," ",.F.}}
EndIf

//"S","Item","Produto","Descri��o","Quantidade","Qtd. Liberada","Valor Unitario", "Total", "Arm"," "	
oItens2:aCols := aItens2
oItens2:ForceRefresh ( ) 
//oItens2:bLine := {|| {aItens2[oItens2:nAt,01],aItens2[oItens2:nAt,02],aItens2[oItens2:nAt,03],aItens2[oItens2:nAt,04],aItens2[oItens2:nAt,05],aItens2[oItens2:nAt,06],;
//						aItens2[oItens2:nAt,07],aItens2[oItens2:nAt,08]}}						
//oItens2:Refresh()

Return lAchou


//**************************************************************
Static Function QA80FIL()

	Local aRet := {}
	

	dbSelectArea("SM0")
	dbGotop()

	aadd(aret,"00-TODAS AS FILIAIS")


	While !Eof()

		//cRet += ";"+SM0->M0_CODFIL+"-"+Alltrim(SM0->M0_FILIAL)
		aadd(aRet,SM0->M0_CODFIL+"-"+Alltrim(SM0->M0_FILIAL))
		dbSkip()

	End While

Return aRet
//**************************************************************
Static Function QA80SX5()

	Local aRet := {}

	dbSelectArea("SX5")
	dbSetOrder(1)
	If dbSeek(xFilial("SX5")+'X4')



		While !Eof() .AND. Alltrim(X5_TABELA) == 'X4'
			If SX5->X5_CHAVE=='999999'
				aadd(aRet,SX5->X5_CHAVE+"-"+Alltrim(SX5->X5_DESCRI))
			End IF
			dbSkip()
		EndDo

	End If	
		
	If dbSeek(xFilial("SX5")+'X4')
		
		While !Eof() .AND. Alltrim(X5_TABELA) == 'X4'
			If SX5->X5_CHAVE<>'999999'
				aadd(aRet,SX5->X5_CHAVE+"-"+Alltrim(SX5->X5_DESCRI))
			End IF
			dbSkip()
		EndDo

	End If

Return aRet

//******************************************************
Static Function ShowNF()

Local cAlias
Local nReg
Local nOpc
Local cFilOri := cFilAnt

cFilAnt := cXFilial 

aArea := GetArea()
dbSelectArea("SF2")
dbSetOrder(1)

If dbSeek(cFilAnt+cNota+cSerie)
 Mc090Visual(cAlias,nReg,nOpc)
End If

cFilAnt := cFilOri 
RestArea(aArea)

Return
//******************************************************

Static Function Altera(xOp)

Local aArea := GetArea()
INCLUI := .T.

dbSelectArea("ZC4")
dbSetOrder(1)

If dbSeek(xFilial("ZC4")+oItens1:aArray[oItens1:nAT,02]+oItens1:aArray[oItens1:nAT,04])

	If xOp == 1
		U_QA040TELA(,,6,.T.,@oDlg1)
	ElseIf xOp == 2
		U_QA040TELA(,,4,.T.,@oDlg1)
	ElseIf xOp == 3
		U_xHisZC4()
	ElseIf xOp == 4
		If MsgYesNo("Deseja ENCERRAR o contrato?")
			RecLock("ZC4",.F.)
				ZC4->ZC4_DTFIM := dDatabase
				ZC4->ZC4_DTREVI := dDatabase
				ZC4->ZC4_OBSOLE	:= .T.
			MsUnlock()
		End If
	End If

End If

RestArea(aArea)

LoadContr(.T.)

Return

Static Function VerBand()
			
	If MsgYesNo("Contrato nao encontrado para o Cliente,deseja consultar pela bandeira do cliente?")
	
		cAliasQry := GetNextAlias()
		
		
		
		If Empty(cLojaCli)
			BeginSql Alias cAliasQry
			%noparser%
			
			SELECT DISTINCT A1_XBAND
			FROM %table:SA1% SA1 WITH (NOLOCK)
			WHERE SA1.%notDel% AND A1_COD=%Exp:cCodCli% AND A1_XBAND<>''
			EndSql
		Else
			BeginSql Alias cAliasQry
			%noparser%
	
			SELECT DISTINCT A1_XBAND
			FROM %table:SA1% SA1 WITH (NOLOCK)
			WHERE SA1.%notDel% AND A1_COD=%Exp:cCodCli% AND A1_LOJA=%Exp:cLojaCli% AND A1_XBAND<>''
			EndSql
		End If
		
		
		
		
		If (cAliasQry)->(!EOF())
			
			cBand := (cAliasQry)->(A1_XBAND)
			oBand:SetFocus()
			oBand:Refresh()
	
			cCodCli  	:= Space(TamSx3("A1_COD")[1])   
			cLojaCli 	:= Space(TamSx3("A1_LOJA")[1])
			oCodCli:Refresh()
			oCodLoja:Refresh()
			
			
			LoadContr(.T.,"cBand")
		End If
	End If

Return

/*/
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������
�������������������������������������������������������������������������Ŀ��
���Programa  �SpedDanfe � Autor �Eduardo Riera          � Data �27.06.2007���
�������������������������������������������������������������������������Ĵ��
���Descri��o �Rotina de chamada do WS de impressao da DANFE               ���
���          �                                                            ���
�������������������������������������������������������������������������Ĵ��
���Retorno   �Nenhum                                                      ���
�������������������������������������������������������������������������Ĵ��
���Parametros�Nenhum                                                      ���
�������������������������������������������������������������������������Ĵ��
���   DATA   � Programador   �Manutencao efetuada                         ���
�������������������������������������������������������������������������Ĵ��
���          �               �                                            ���
��������������������������������������������������������������������������ٱ�
�����������������������������������������������������������������������������
�����������������������������������������������������������������������������
/*/
Static Function xDanfe(xFil)

Local cIdEnt := ""
Local aIndArq   := {}
Local oDanfe
Local nHRes  := 0
Local nVRes  := 0
Local nDevice
Local cFilePrint := ""
Local oSetup
Local aDevice  := {}
Local cSession     := GetPrinterSession()
Local nRet := 0
Local lUsaColab	:= UsaColaboracao("1") 

cFilAtu := cFilAnt
cFilAnt := xFil

If findfunction("U_DANFE_V")
	nRet := U_Danfe_v()
Elseif findfunction("U_DANFE_VI") // Incluido esta valida��o pois o cliente informou que n�o utiliza o DANFEII
	nRet := U_Danfe_vi() 
EndIf

AADD(aDevice,"DISCO") // 1
AADD(aDevice,"SPOOL") // 2
AADD(aDevice,"EMAIL") // 3
AADD(aDevice,"EXCEL") // 4
AADD(aDevice,"HTML" ) // 5
AADD(aDevice,"PDF"  ) // 6

cFilAnt := '01'
cIdEnt := GetIdEnt(lUsaColab,xFil)

Pergunte("NFSIGW",.F.)

cFilePrint := "DANFE_"+cIdEnt+Dtos(MSDate())+StrTran(Time(),":","")
                                                                        
nLocal       	:= If(fwGetProfString(cSession,"LOCAL","SERVER",.T.)=="SERVER",1,2 )
nOrientation 	:= If(fwGetProfString(cSession,"ORIENTATION","PORTRAIT",.T.)=="PORTRAIT",1,2)
cDevice     	:= If(Empty(fwGetProfString(cSession,"PRINTTYPE","SPOOL",.T.)),"PDF",fwGetProfString(cSession,"PRINTTYPE","SPOOL",.T.))
nPrintType      := aScan(aDevice,{|x| x == cDevice })
//�������������������������������������������Ŀ
//�Ajuste no pergunte NFSIGW                  �
//���������������������������������������������
//AjustaSX1()

If IsReady(,,,lUsaColab)
	dbSelectArea("SF2")
	RetIndex("SF2")
	dbClearFilter() 
	//������������������������������������������������������������������������Ŀ
	//�Obtem o codigo da entidade                                              �
	//��������������������������������������������������������������������������	
	If nRet >= 20100824
	
		lAdjustToLegacy := .F. // Inibe legado de resolu��o com a TMSPrinter
		oDanfe := FWMSPrinter():New(cFilePrint, IMP_PDF, lAdjustToLegacy, /*cPathInServer*/, .T.)
		
		// ----------------------------------------------
		// Cria e exibe tela de Setup Customizavel
		// OBS: Utilizar include "FWPrintSetup.ch"
		// ----------------------------------------------
		//nFlags := PD_ISTOTVSPRINTER+ PD_DISABLEORIENTATION + PD_DISABLEPAPERSIZE + PD_DISABLEPREVIEW + PD_DISABLEMARGIN
		nFlags := PD_ISTOTVSPRINTER + PD_DISABLEPAPERSIZE + PD_DISABLEPREVIEW + PD_DISABLEMARGIN
		If ( !oDanfe:lInJob )
			oSetup := FWPrintSetup():New(nFlags, "DANFE")
			// ----------------------------------------------
			// Define saida
			// ----------------------------------------------
			oSetup:SetPropert(PD_PRINTTYPE   , nPrintType)
			oSetup:SetPropert(PD_ORIENTATION , nOrientation)
			oSetup:SetPropert(PD_DESTINATION , nLocal)
			oSetup:SetPropert(PD_MARGIN      , {60,60,60,60})
			oSetup:SetPropert(PD_PAPERSIZE   , 2)

			If ExistBlock( "SPNFESETUP" )
				Execblock( "SPNFESETUP" , .F. , .F. , {oDanfe, oSetup} )
			Endif
		EndIf
		
		// ----------------------------------------------
		// Pressionado bot�o OK na tela de Setup
		// ----------------------------------------------
		If oSetup:Activate() == PD_OK // PD_OK =1
			//�������������������������������������������Ŀ
			//�Salva os Parametros no Profile             �
			//���������������������������������������������
	
	        fwWriteProfString( cSession, "LOCAL"      , If(oSetup:GetProperty(PD_DESTINATION)==1 ,"SERVER"    ,"CLIENT"    ), .T. )
	        fwWriteProfString( cSession, "PRINTTYPE"  , If(oSetup:GetProperty(PD_PRINTTYPE)==2   ,"SPOOL"     ,"PDF"       ), .T. )
	        fwWriteProfString( cSession, "ORIENTATION", If(oSetup:GetProperty(PD_ORIENTATION)==1 ,"PORTRAIT"  ,"LANDSCAPE" ), .T. )
			
			// Configura o objeto de impress�o com o que foi configurado na interface.
	        oDanfe:setCopies( val( oSetup:cQtdCopia ) )
			
			If oSetup:GetProperty(PD_ORIENTATION) == 1
				//�������������������������������������������Ŀ
				//�Danfe Retrato DANFEII.PRW                  �
				//���������������������������������������������			
				u_PrtNSef(cIdEnt ,cNota,cSerie ,oDanfe ,oSetup ,cFilePrint ,/*lIsLoja*/ )
			Else
				//�������������������������������������������Ŀ
				//�Danfe Paisagem DANFEIII.PRW                �
				//���������������������������������������������
				//u_DANFE_P1(cIdEnt ,/*cVal1*/ ,/*cVal2*/ ,oDanfe ,oSetup ,/*lIsLoja*/ )
			EndIf
			
		Else
		MsgInfo("Relat�rio cancelado pelo usu�rio.")
		Pergunte("NFSIGW",.F.)
		//bFiltraBrw := {|| FilBrowse(aFilBrw[1],@aIndArq,@aFilBrw[2])}
		//Eval(bFiltraBrw)
		Return
		Endif
	
	Else
	 	u_PrtNSef(cIdEnt ,cNota,cSerie ,oDanfe ,oSetup ,cFilePrint ,/*lIsLoja*/ )
	EndIf		

	Pergunte("NFSIGW",.F.)
	//bFiltraBrw := {|| FilBrowse(aFilBrw[1],@aIndArq,@aFilBrw[2])}
	//Eval(bFiltraBrw)
EndIf
oDanfe := Nil
oSetup := Nil

//Limpa arquivos temporarios .rel da pasta MV_RELT
//SpedCleRelt()
cFilAnt := cFilAtu
Return()

Static Function GetIdEnt(lUsaColab,xFil)

Local cEvento		:= ""
Local cParCLeRem    := SM0->M0_CODIGO+SM0->M0_CODFIL+"SPEDCLEREM"
Local cParamEven	:= SM0->M0_CODIGO+SM0->M0_CODFIL
Local cRotina       := ""
Local cUF			:= Upper(Left(LTrim(SM0->M0_ESTENT),2))
Local cURL       	:= PadR(GetNewPar("MV_SPEDURL","http://"),250)
Local cUseAlias		:= "SF2"
local cError		:= ""
Local lEntAtiva     := .T.
Local lEvento		:= .F.
Local lRetorno      := .T.
Local cGrupo		:= FWGrpCompany()		//Retorna o grupo
Local cFil 			:= FWCodFil()			//Retorna o c�digo da filial
local cIdEnt 		:= ""

If xFil == '01'
	cIdEnt := "000001"
ElseIf xFil == '02'
	cIdEnt := "000005"
ElseIf xFil == '03'
	cIdEnt := "000002"
ElseIf xFil == '04'
	cIdEnt := "000003"
ElseIf xFil == '05'
	cIdEnt := "000004"
ElseIf xFil == '07'
	cIdEnt := "000006"
ElseIf xFil == '08'
	cIdEnt := "000007"
ElseIf xFil == '09'
	cIdEnt := "000009"
ElseIf xFil == '10'
	cIdEnt := "000010"
ElseIf xFil == '13'
	cIdEnt := "000013"
End If

return cIdEnt

Default lUsaColab := .F.

If !lUsaColab

	cIdEnt := getCfgEntidade(@cError)

	if(empty(cIdEnt))
		Aviso("SPED", cError, {"ok"}, 3)

	endif	

else
	if !( ColCheckUpd() )
		Aviso("SPED","UPDATE do TOTVS Colabora��o 2.0 n�o aplicado. Desativado o uso do TOTVS Colabora��o 2.0",{"OK"},3)
	else
		cIdEnt := "000000"
	endif	 
endIf	

Return(cIdEnt)

Static Function IsReady(cURL,nTipo,lHelp,lUsaColab)

Local nX       := 0
Local cHelp    := ""
local cError	:= ""
Local oWS
Local lRetorno := .F.
DEFAULT nTipo := 1
DEFAULT lHelp := .F.
DEFAULT lUsaColab := .F.
if !lUsaColab
   If FunName() <> "LOJA701"
   		If !Empty(cURL) .And. !PutMV("MV_SPEDURL",cURL)
			RecLock("SX6",.T.)
			SX6->X6_FIL     := xFilial( "SX6" )
			SX6->X6_VAR     := "MV_SPEDURL"
			SX6->X6_TIPO    := "C"
			SX6->X6_DESCRIC := "URL SPED NFe"
			MsUnLock()
			PutMV("MV_SPEDURL",cURL)
		EndIf
		SuperGetMv() //Limpa o cache de parametros - nao retirar
		DEFAULT cURL      := PadR(GetNewPar("MV_SPEDURL","http://"),250)
	Else
		If !Empty(cURL) .And. !PutMV("MV_NFCEURL",cURL)
			RecLock("SX6",.T.)
			SX6->X6_FIL     := xFilial( "SX6" )
			SX6->X6_VAR     := "MV_NFCEURL"
			SX6->X6_TIPO    := "C"
			SX6->X6_DESCRIC := "URL de comunica��o com TSS"
			MsUnLock()
			PutMV("MV_NFCEURL",cURL)
		EndIf
		SuperGetMv() //Limpa o cache de parametros - nao retirar
		DEFAULT cURL      := PadR(GetNewPar("MV_NFCEURL","http://"),250)	
	EndIf	
	//Verifica se o servidor da Totvs esta no ar	
	if(isConnTSS(@cError))	
		lRetorno := .T.
	Else
		If lHelp
			Aviso("SPED",IIf(Empty(GetWscError(3)),GetWscError(1),GetWscError(3)),{"OK"},3)
		EndIf
		lRetorno := .F.
	EndIf
	
	
	//Verifica se H� Certificado configurado	
	If nTipo <> 1 .And. lRetorno		
		
		if( isCfgReady(, @cError) )
			lRetorno := .T.
		else	
			If nTipo == 3
				cHelp := cError
			
				If lHelp .And. !"003" $ cHelp
					Aviso("SPED",cHelp,{"OK"},3)
					lRetorno := .F.
			
				EndIf		
			
			Else
				lRetorno := .F.
			
			EndIf
		endif

	EndIf
	
	//Verifica Validade do Certificado	
	If nTipo == 2 .And. lRetorno
		isValidCert(, @cError)
	EndIf
else
	lRetorno := ColCheckUpd()
	if lHelp .And. !lRetorno .And. !lAuto
		MsgInfo("UPDATE do TOTVS Colabora��o 2.0 n�o aplicado. Desativado o uso do TOTVS Colabora��o 2.0")		
	endif	
endif

Return(lRetorno)

static function xCabZC5()
    
local aCabec := {}
local aCampos:= {}
AADD(aCampos,"ZC5_CODVER")
AADD(aCampos,"ZC5_DESC")
AADD(aCampos,"ZC5_CALCUL")
AADD(aCampos,"ZC5_FORMA")
AADD(aCampos,"ZC5_PERCEN")
AADD(aCampos,"ZC5_DEVOLV")
    
// CAMPOS QUE SER�O UTILIZADOS DA SA2
DbSelectArea("SX3")
SX3->(DbSetOrder(2))

//Adiciona Campos conforme ordem informada
For nCampo:=1 To Len(aCampos)
	If DbSeek(PadR(aCampos[nCampo],10))
		    Aadd(aCabec, {SX3->X3_TITULO,;
					      SX3->X3_CAMPO,;  	
					      SX3->X3_PICTURE,;	
					      SX3->X3_TAMANHO,;
					      SX3->X3_DECIMAL,;
					      SX3->X3_VALID,;
					      SX3->X3_USADO,;
					      SX3->X3_TIPO,;
					      SX3->X3_F3,; 	
					      SX3->X3_CONTEXT,;
					      SX3->X3_CBOX,;
					      SX3->X3_RELACAO,;
					      SX3->X3_WHEN,;	
					      "V"})		
	Endif
Next

return aCabec